<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bill Splitter</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/lucide/dist/umd/lucide.js"></script>
<style>
  body { font-family: 'Inter', sans-serif; background:#f0f2f5; color:#333; }
  .flat-input { border-radius:0; border-bottom:2px solid #ccc; background:transparent; padding:0.75rem; transition:border-color 0.2s; }
  .flat-input:focus { outline:none; border-color:#3b82f6; }
  .flat-btn { border-radius:0; box-shadow:none; }
  .flat-card { border-radius:0.5rem; box-shadow:none; background:white; padding:1rem; }
  @media print { .no-print { display:none !important; } }
  .animate-slide-up { animation: slide-up 0.5s ease-out forwards; }
  @keyframes slide-up { from { transform:translateY(100px); opacity:0; } to { transform:translateY(0); opacity:1; } }
</style>
</head>
<body class="min-h-screen">

<div id="app" class="container mx-auto p-4 max-w-md"></div>
<div id="modalContainer"></div>
<div id="messageContainer"></div>

<script>
/* ---------------------- CONFIG & STATE ---------------------- */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCsDZ462_BV5mP4z1OqWu3F4WQWuB7seomvjuzkXaEijE1ZnSNB2p0_gHHM4zEgT0_Rw/exec";
const GST_RATE = 8;

let people = [
  {id:'miu', name:'Miu'}, {id:'raya', name:'Raya'}, {id:'aslan', name:'Aslan'},
  {id:'reesha', name:'Reesha'}, {id:'appal', name:'Appal'}, {id:'uly', name:'Uly'},
  {id:'irufaan', name:'Irufaan'}
];
let items = [], isGstEnabled=false, otherCharges=0, selectedPersonId=people[0].id;
let currentScreen='main', modalType=null, message=null;
let billDate='', vendorName='', actualPaidTotal='', payerName='', billCounter=1;
let savedBills = JSON.parse(localStorage.getItem('savedBills')||'[]');

/* ---------------------- UTILITY ---------------------- */
const getIcon=(name)=>lucide.icons[name] ? lucide.icons[name] : '';
const showMessage=(text,type='success')=>{
  message={text,type};
  renderMessage();
  setTimeout(()=>{message=null; renderMessage();},3000);
};
const capitalize=(str)=>str ? str.split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ') : '';

/* ---------------------- RENDER ---------------------- */
const renderApp=()=>{
  const appDiv=document.getElementById('app');
  appDiv.innerHTML=`<h1 class="text-3xl font-extrabold text-center mb-6 text-blue-600">Bill Splitter</h1>`;
  if(currentScreen==='main'){ renderMainScreen(); } else { renderHistoryScreen(); }
  renderModal(); renderMessage();
};

const renderMainScreen=()=>{
  const appDiv=document.getElementById('app');
  const itemsByPerson = items.reduce((acc,it)=>{ (acc[it.assignedTo]=acc[it.assignedTo]||[]).push(it); return acc; },{});
  const container=document.createElement('div');
  container.className='space-y-5';

  container.innerHTML=`
  <div class="flat-card space-y-3">
    <h2 class="font-bold text-lg text-gray-800">Bill Details</h2>
    <input type="date" id="billDate" value="${billDate}" class="w-full flat-input">
    <input type="text" id="vendorName" placeholder="Vendor Name" value="${vendorName}" class="w-full flat-input">
    <input type="number" id="actualPaidTotal" placeholder="Actual Paid Total" value="${actualPaidTotal}" step="0.01" class="w-full flat-input">
  </div>
  
  <div class="flat-card space-y-3">
    <h2 class="font-bold text-lg text-gray-800">Add Item</h2>
    <select id="personSelect" class="w-full flat-input mb-2">${people.map(p=>`<option value="${p.id}" ${selectedPersonId===p.id?'selected':''}>${p.name}</option>`).join('')}</select>
    <input type="text" id="itemName" placeholder="Item Name" class="w-full flat-input mb-2">
    <input type="number" id="itemCost" placeholder="Cost" class="w-full flat-input mb-2" step="0.01">
    <button id="addItemBtn" class="w-full flat-btn bg-blue-600 text-white font-semibold py-2">Add Item</button>
  </div>

  <div class="flat-card space-y-2">
    <h2 class="font-bold text-lg text-gray-800">Current Items</h2>
    ${people.map(p=>{
      const personItems=itemsByPerson[p.id]||[];
      if(personItems.length===0) return '';
      return `<div class="p-2 border-b last:border-b-0">
        <p class="font-semibold text-blue-600">${p.name}</p>
        ${personItems.map(it=>`<div class="flex justify-between text-gray-800 text-sm py-1">
          <span>${it.name}</span>
          <span>MVR${it.cost.toFixed(2)} <button data-id="${it.id}" class="text-red-500 remove-item-btn">${getIcon('X')}</button></span>
        </div>`).join('')}
      </div>`;
    }).join('')}
    ${items.length===0?'<p class="text-gray-500 text-center text-sm">No items yet</p>':''}
  </div>

  <div class="flex gap-2">
    <button id="toggleGst" class="flex-1 flat-btn py-2 ${isGstEnabled?'bg-green-600 text-white':'bg-gray-300'}">GST ${isGstEnabled?`(${GST_RATE}%)`:''}</button>
    <input type="number" id="otherCharges" value="${otherCharges}" placeholder="Other" class="flex-1 flat-input">
  </div>

  <div class="flex gap-2">
    <button id="resetBillBtn" class="flex-1 bg-red-600 text-white flat-btn py-2">Reset</button>
    <button id="generateBillBtn" class="flex-1 bg-purple-600 text-white flat-btn py-2">Generate Bill</button>
    <button id="historyTabBtn" class="flex-1 bg-gray-300 flat-btn py-2">History</button>
  </div>
  `;
  appDiv.appendChild(container);

  // Event listeners
  document.getElementById('addItemBtn').onclick=()=>{ 
    const name=capitalize(document.getElementById('itemName').value.trim());
    const cost=parseFloat(document.getElementById('itemCost').value);
    const pid=document.getElementById('personSelect').value;
    if(!name||isNaN(cost)||cost<=0){showMessage('Invalid item','error');return;}
    items.push({id:`item-${Date.now()}`,name,cost,assignedTo:pid});
    document.getElementById('itemName').value=''; document.getElementById('itemCost').value=''; renderApp();
  };
  document.querySelectorAll('.remove-item-btn').forEach(btn=>{
    btn.onclick=()=>{ items=items.filter(it=>it.id!==btn.getAttribute('data-id')); renderApp(); };
  });
  document.getElementById('toggleGst').onclick=()=>{ isGstEnabled=!isGstEnabled; renderApp(); };
  document.getElementById('otherCharges').oninput=(e)=>{ otherCharges=parseFloat(e.target.value)||0; };
  document.getElementById('resetBillBtn').onclick=()=>{ items=[]; billDate=''; vendorName=''; actualPaidTotal=''; renderApp(); };
  document.getElementById('generateBillBtn').onclick=()=>{ modalType='selectPayer'; renderModal(); };
  document.getElementById('historyTabBtn').onclick=()=>{ currentScreen='history'; renderApp(); };
};

const renderHistoryScreen=()=>{
  const appDiv=document.getElementById('app');
  const container=document.createElement('div'); container.className='space-y-4';
  container.innerHTML=`<button id="backBtn" class="flat-btn py-2 px-3 bg-gray-300 w-full">Back</button>`;
  savedBills.reverse().forEach((b,i)=>{
    container.innerHTML+=`
      <div class="flat-card">
        <div class="flex justify-between items-center cursor-pointer" onclick="document.getElementById('billDetail${i}').classList.toggle('hidden')">
          <span class="font-bold">${b.billNumber} - ${b.vendor}</span>
          <span>MVR${b.actualPaidTotal}</span>
        </div>
        <div id="billDetail${i}" class="hidden mt-2 space-y-1">
          <p>Date: ${b.billDate}</p>
          <p>Payer: ${b.payer}</p>
          <p>Items:</p>
          ${b.items.map(it=>`<div class="flex justify-between text-sm"><span>${it.name}</span><span>MVR${it.cost.toFixed(2)}</span></div>`).join('')}
        </div>
      </div>`;
  });
  appDiv.appendChild(container);
  document.getElementById('backBtn').onclick=()=>{ currentScreen='main'; renderApp(); };
};

const renderModal=()=>{
  const modalContainer=document.getElementById('modalContainer'); if(!modalType){modalContainer.innerHTML=''; return;}
  if(modalType==='selectPayer'){
    modalContainer.innerHTML=`
      <div class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div class="flat-card w-full max-w-sm text-center space-y-3">
          <h3 class="font-semibold text-lg">Select Payer</h3>
          <select id="payerSelect" class="w-full flat-input mb-2">${people.map(p=>`<option value="${p.name}">${p.name}</option>`).join('')}</select>
          <div class="flex gap-2">
            <button id="cancelPayerBtn" class="flex-1 flat-btn bg-gray-300 py-2">Cancel</button>
            <button id="confirmPayerBtn" class="flex-1 flat-btn bg-purple-600 text-white py-2">Confirm</button>
          </div>
        </div>
      </div>
    `;
    document.getElementById('cancelPayerBtn').onclick=()=>{ modalType=null; renderModal(); };
    document.getElementById('confirmPayerBtn').onclick=()=>{
      payerName=document.getElementById('payerSelect').value; modalType=null; generateBill();
    };
  }
};

const renderMessage=()=>{ 
  const msgDiv=document.getElementById('messageContainer'); 
  if(!message){msgDiv.innerHTML=''; return;}
  msgDiv.innerHTML=`<div class="fixed top-4 left-1/2 -translate-x-1/2 px-6 py-2 rounded shadow text-white z-50 bg-${message.type==='success'?'green':'red'}-500">${message.text}</div>`;
};

/* ---------------------- BILL GENERATION ---------------------- */
const generateBill=()=>{
  if(items.length===0){showMessage('Add items first','error'); return;}
  const bill={billNumber:billCounter++, billDate, vendor:vendorName, actualPaidTotal, payer:payerName, items, gstEnabled:isGstEnabled, otherCharges};
  savedBills.push(bill); localStorage.setItem('savedBills',JSON.stringify(savedBills));
  fetch(GOOGLE_SCRIPT_URL,{method:'POST',body:JSON.stringify(bill)}).then(()=>showMessage('Bill saved')).catch(()=>showMessage('Error','error'));
  items=[]; actualPaidTotal=''; renderApp();
};

/* ---------------------- INIT ---------------------- */
window.onload=()=>{ renderApp(); };
</script>
</body>
</html>
