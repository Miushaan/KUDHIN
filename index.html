<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KUDHIN SPLIT â€” Modern</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); }
    .flat-input { border: 1px solid #ddd; background: #f9f9f9; }
    .flat-input:focus { background: #fff; outline: none; }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

  <!-- Header -->
  <header class="glass p-4 shadow-md text-center text-xl font-bold text-blue-700">KUDHIN SPLIT</header>

  <!-- Main -->
  <main id="main" class="flex-1 overflow-y-auto p-4 max-w-md mx-auto w-full">
    <!-- Bill screen -->
    <section id="bill-screen" class="space-y-4">
      <div class="glass rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold mb-3">Bill Details</h2>
        <input id="bill-name" placeholder="Bill Name" class="w-full px-4 py-3 flat-input rounded-lg text-base mb-3">
        <input id="bill-date" type="date" class="w-full px-4 py-3 flat-input rounded-lg text-base mb-3">
        <input id="bill-total" type="number" placeholder="Actual Paid Total (MVR)" class="w-full px-4 py-3 flat-input rounded-lg text-base">
      </div>

      <div class="glass rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold mb-3">Items</h2>
        <div id="items-list" class="space-y-2"></div>
        <button onclick="addItem()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">+ Add Item</button>
      </div>

      <div class="glass rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold mb-3">Options</h2>
        <label class="flex items-center space-x-2 mb-2">
          <input id="gst-toggle" type="checkbox" class="h-5 w-5 text-blue-600">
          <span>Include GST (8%)</span>
        </label>
        <input id="other-charges" type="number" placeholder="Other Charges (MVR)" class="w-full px-4 py-3 flat-input rounded-lg text-base">
      </div>

      <button onclick="goToReport()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">Generate Report</button>
    </section>

    <!-- Report screen -->
    <section id="report-screen" class="hidden space-y-4"></section>

    <!-- History screen -->
    <section id="history-screen" class="hidden space-y-4">
      <h2 class="text-lg font-semibold mb-3">Saved Bills</h2>
      <div id="history-list" class="space-y-2"></div>
    </section>
  </main>

  <!-- Bottom Nav -->
  <nav class="glass shadow-inner flex justify-around p-2">
    <button onclick="switchTab('bill-screen')" class="flex flex-col items-center text-blue-600">
      <span id="bill-icon"></span>
      <span class="text-sm">Bill</span>
    </button>
    <button onclick="switchTab('report-screen')" class="flex flex-col items-center text-gray-500">
      <span id="report-icon"></span>
      <span class="text-sm">Report</span>
    </button>
    <button onclick="switchTab('history-screen')" class="flex flex-col items-center text-gray-500">
      <span id="history-icon"></span>
      <span class="text-sm">History</span>
    </button>
  </nav>

  <!-- Message -->
  <div id="message" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg hidden"></div>

  <script>
    // Google Script backend
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCsDZ462_BV5mP4z1OqWu3F4WQWuB7seomvjuzkXaEijE1ZnSNB2p0_gHHM4zEgT0_Rw/exec";

    // Helpers
    const showMessage = (msg, type="info") => {
      const el = document.getElementById("message");
      el.textContent = msg;
      el.className = "fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg text-white " +
        (type==="success"?"bg-green-600":type==="error"?"bg-red-600":"bg-gray-800");
      el.classList.remove("hidden");
      setTimeout(()=>el.classList.add("hidden"),3000);
    };

    const getIcon = (name, size=20) => {
      if (!lucide.icons[name]) return "";
      return lucide.icons[name]({width:size,height:size}).outerHTML;
    };

    // Nav icons
    document.getElementById("bill-icon").innerHTML = getIcon("file-text");
    document.getElementById("report-icon").innerHTML = getIcon("bar-chart-2");
    document.getElementById("history-icon").innerHTML = getIcon("clock");

    // State
    let items = [];

    const switchTab = (id) => {
      ["bill-screen","report-screen","history-screen"].forEach(s=>{
        document.getElementById(s).classList.add("hidden");
      });
      document.getElementById(id).classList.remove("hidden");
      if(id==="report-screen") updateReportScreen();
      if(id==="history-screen") loadBills();
    };

    // Add Item
    const addItem = () => {
      const item = {name:"",qty:1,price:0};
      items.push(item);
      renderItems();
    };

    const renderItems = () => {
      const list = document.getElementById("items-list");
      list.innerHTML = "";
      items.forEach((it,i)=>{
        const row = document.createElement("div");
        row.className = "flex space-x-2";
        row.innerHTML = `
          <input placeholder="Item" value="${it.name}" oninput="items[${i}].name=this.value" class="flex-1 px-3 py-2 flat-input rounded-lg">
          <input type="number" value="${it.qty}" oninput="items[${i}].qty=this.value" class="w-16 px-3 py-2 flat-input rounded-lg">
          <input type="number" value="${it.price}" oninput="items[${i}].price=this.value" class="w-24 px-3 py-2 flat-input rounded-lg">
          <button onclick="removeItem(${i})" class="text-red-600">${getIcon("trash")}</button>
        `;
        list.appendChild(row);
      });
    };

    const removeItem = (i) => { items.splice(i,1); renderItems(); };

    // Report
    const goToReport = () => {
      switchTab("report-screen");
    };

    const updateReportScreen = () => {
      const name = document.getElementById("bill-name").value;
      const date = document.getElementById("bill-date").value;
      const total = parseFloat(document.getElementById("bill-total").value||0);
      const gst = document.getElementById("gst-toggle").checked;
      const other = parseFloat(document.getElementById("other-charges").value||0);

      let subtotal = items.reduce((s,i)=>s+(i.qty*i.price),0);
      if(gst) subtotal *= 1.08;
      subtotal += other;

      const report = document.getElementById("report-screen");
      report.innerHTML = `
        <div class="glass p-4 rounded-lg shadow">
          <h2 class="text-lg font-semibold mb-3">Report</h2>
          <p><b>Name:</b> ${name}</p>
          <p><b>Date:</b> ${date}</p>
          <p><b>Total (Calculated):</b> MVR ${subtotal.toFixed(2)}</p>
          <p><b>Total (Entered):</b> MVR ${total.toFixed(2)}</p>
        </div>
        <button onclick="saveBill()" class="w-full mt-3 px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold">Save Bill</button>
      `;
    };

    // Save to Google Sheet
    const saveBill = async () => {
      const data = {
        name: document.getElementById("bill-name").value,
        date: document.getElementById("bill-date").value,
        total: document.getElementById("bill-total").value,
        items: items
      };
      try {
        const res = await fetch(GOOGLE_SCRIPT_URL,{
          method:"POST",
          body: JSON.stringify({action:"saveBill", bill:data}),
          headers:{"Content-Type":"application/json"}
        });
        const out = await res.json();
        if(out.success) showMessage("Bill saved successfully!","success");
        else showMessage("Save failed","error");
      } catch(e) {
        showMessage("Error saving bill","error");
        console.error(e);
      }
    };

    // Load saved bills
    const loadBills = async () => {
      try {
        const res = await fetch(GOOGLE_SCRIPT_URL+"?action=getBills");
        const out = await res.json();
        const list = document.getElementById("history-list");
        list.innerHTML = "";
        if(out.success && out.bills.length){
          out.bills.forEach(b=>{
            const div=document.createElement("div");
            div.className="glass p-3 rounded-lg shadow";
            div.innerHTML=`<b>${b.name}</b> - ${b.date} - MVR ${b.total}`;
            list.appendChild(div);
          });
        } else {
          list.innerHTML = "<p class='text-gray-500'>No saved bills.</p>";
        }
      } catch(e) {
        showMessage("Error loading bills","error");
      }
    };
  </script>
</body>
</html>
